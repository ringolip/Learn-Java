### 多线程



#### 进程

正在运行的程序，是系统进行资源分配和调用的独立单位。

每一个进程都有它自己的内存空间和系统资源。



#### 线程

是进程中的单个顺序控制流，是一条执行路径

线程是程序的执行单元，是程序使用CPU的最基本单位。



#### 单线程

如果程序只有一条执行路径



#### 多线程

如果程序有多条执行路径



#### 多进程的意义

提高CPU的使用率



#### 多线程的意义

不是提高程序的执行速度，而是提高程序的使用率

程序的执行实际都是在抢占CPU的资源，CPU执行权。

多个进程抢占资源，如果某个进程的执行路径较多，则更有机率抢占到CPU的执行权



#### 并行和并发

##### 并行

是**逻辑**上同时发生，指在某一个时间段同时运行多个程序。

##### 并发

是**物理**上同时发生，指在某一个时间点同时运行多个程序。

我们能不能实现真正意义上的并发呢，是可以的，多个CPU就可以实现，不过你得知道如何调度和控制它们。



---

### java程序的运行原理



1. java 命令会启动 java 虚拟机，启动 JVM，等于启动了一个应用程序，也就是启动了一个进程。

2. 该进程会自动启动一个 “主线程” ，然后主线程去调用某个类的 main 方法。所以 main方法运行在主线程中。在此之前的所有程序都是单线程的。



#### JVM的启动

JVM启动至少启动了**垃圾回收线程**和**主线程**，所以是多线程的。



---

### 多线程的实现方案



#### 一种方法是将类声明为 `Thread` 的子类。

该子类应重写 `Thread` 类的 `run` 方法。



#### Thread的run()方法和strat()方法的区别

run仅仅是封装被线程执行的代码，直接调用是普通方法（线程没有启动）

start首先启动了线程，再由jvm去调用该线程的run方法。



#### 创建线程的另一种方法是声明实现 `Runnable` 接口的类。

实现接口方式的好处

可以避免由于Java单继承带来的局限性。

适合多个相同程序的代码去处理同一个资源的情况，把线程同程序的代码，数据有效分离，较好的体现了面向对

象的设计思想。



---

### 线程的调度及优先级问题

线程的调度

- 分时调度

所有线程轮流使用 CPU 的使用权，平均分配每个线程占用 CPU 的时间片

- 抢占式调度

优先让优先级高的线程使用 CPU，如果线程的优先级相同，那么会随机选择一个，优先级高的线程获取的 CPU 

时间片相对多一些。 



#### 如何设置和获取优先级

线程优先级仅仅表示获取CPU时间片的几率高，但是要在次数比较多或者多次运行时才能看到比较好的效果。



默认是5

范围是1-10



| java.lang.[Thread](https://tool.oschina.net/uploads/apidocs/jdk-zh/java/lang/Thread.html) |                 |      |
| ------------------------------------------------------------ | --------------- | ---- |
| `public static final int`                                    | `MAX_PRIORITY`  | `10` |
| `public static final int`                                    | `MIN_PRIORITY`  | `1`  |
| `public static final int`                                    | `NORM_PRIORITY` | `5`  |



public final int getPriority() 获取线程优先级

public final void setPriority(int newPriority) 设置线程优先级





---

### 线程的控制（常见方法）

##### 线程休眠

public static void sleep(long millis)

##### 线程加入

public final void join() 等待该线程终止其他线程再运行。

##### 线程礼让

public static void yield() 多个线程执行更和谐

##### 后台线程

public final void setDaemon(boolean on)

将该线程标记为守护线程或用户线程。当正在运行的线程都是守护线程时，Java 虚拟机退出。

##### 中断线程

public final void stop() 不安全

public void interrupt()

把线程状态终止，并抛出异常。



---

### 线程的生命周期

线程生命周期图

​		A:新建

​		B:就绪

​		C:运行

​		D:阻塞

​		E:死亡



---



### 多线程安全问题的原因

也是我们以后判断一个程序是否有线程安全问题的依据

A:是否有多线程环境

B:是否有共享数据

C:是否有多条语句操作共享数据





---

### 同步解决线程安全



#### 同步代码块

格式：

```java
synchronized(对象) {
  需要同步的代码;
}
```



##### 同步的前提

- 多个线程

- 多个线程使用的是同一个锁对象

##### 同步的好处

同步的出现解决了多线程的安全问题。

##### 同步的弊端

当线程相当多时，因为每个线程都会去判断同步上的锁，这是很**耗费资源**的，无形中会降低程序的运行效率。



#### 同步方法

把`synchronized`关键字加在方法上

同步方法的锁对象是`this`



#### 静态同步方法

把同步加在方法上

这里的锁对象是当前类的字节码文件对象



---

#### Lock锁

JDK5以后的针对线程的锁定操作和释放操作

更加明确了在那里加上锁



`Lock` 实现提供了比使用 `synchronized` 方法和语句可获得的更广泛的锁定操作。	



---

#### 死锁问题





